<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดส่งลิงก์คลิปวิดีโอ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f8f9fa; }
        .navbar { background-color: #002654; }
        .btn-primary { background-color: #C8102E; border-color: #C8102E; }
        .btn-primary:hover { animation: pulse 0.5s; }
        .footer { background-color: #002654; color: white; padding: 10px; text-align: center; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand text-white" href="#">ระบบจัดส่งลิงก์คลิปวิดีโอ</a>
        </div>
    </nav>

    <div class="container mt-5" data-aos="fade-up">
        <h2 class="text-center mb-4">กรอกข้อมูล</h2>
        <form id="submitForm">
            <div class="mb-3">
                <label for="school" class="form-label">โรงเรียน</label>
                <input type="text" class="form-control" id="school" required>
            </div>
            <div class="mb-3">
                <label for="name" class="form-label">ชื่อ-สกุล</label>
                <input type="text" class="form-control" id="name" required>
            </div>
            <div class="mb-3">
                <label for="position" class="form-label">ตำแหน่ง</label>
                <input type="text" class="form-control" id="position" required>
            </div>
            <div class="mb-3">
                <label for="phone" class="form-label">เบอร์โทรศัพท์</label>
                <input type="tel" class="form-control" id="phone" required>
            </div>
            <div class="mb-3">
                <label for="url" class="form-label">URL คลิปวิดีโอ</label>
                <input type="url" class="form-control" id="url" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">บันทึก</button>
        </form>
    </div>

    <div class="container mt-5" data-aos="fade-up">
        <h2 class="text-center mb-4">รายชื่อโรงเรียนที่จัดส่งล่าสุด</h2>
        <table id="schoolTable" class="table table-striped">
            <thead>
                <tr>
                    <th>ลำดับ</th>
                    <th>โรงเรียน</th>
                    <th>คลิปวิดีโอที่จัดส่ง</th>
                    <th>ดูเกียรติบัตรย้อนหลัง</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <footer class="footer mt-5">
        © 2025 สำนักงานเขตพื้นที่การศึกษาประถมศึกษาชลบุรี เขต 2 | พัฒนาโดยทีม ICT สำนักงานเขตพื้นที่การศึกษาประถมศึกษาชลบุรี เขต 2
    </footer>

    <div class="modal fade" id="certModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เกียรติบัตร</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="loading" style="display: none;">กำลังประมวลผล... กรุณารอสักครู่</div>
                    <canvas id="certCanvas" style="width: 100%; height: auto; border: 1px solid #ddd;"></canvas>
                </div>
                <div class="modal-footer">
                    <button id="downloadPng" class="btn btn-primary" disabled>ดาวน์โหลด PNG</button>
                    <button id="downloadJpg" class="btn btn-primary" disabled>ดาวน์โหลด JPG</button>
                    <button id="downloadPdf" class="btn btn-primary" disabled>ดาวน์โหลด PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        AOS.init();
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbwRRdAyamOyu7S8dvf8f3w5WtOHfxPPeJi8ncnQl1sd-Nsrwl78G7U6mPYETXjM79bR/exec'; // URL ใหม่ของคุณ
        const logo1 = 'https://lh3.googleusercontent.com/d/1reqwwQP7acieFotjwOkM4qYIg9w1A3rf';
        const logo2 = 'https://lh3.googleusercontent.com/d/1N1qX5HosVt7ap2zWBw-RFm2oiD2oIwfC';
        const flagUrl = 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a9/Flag_of_Thailand.svg/1024px-Flag_of_Thailand.svg.png';
        let currentSchool = '';
        let certModal = new bootstrap.Modal(document.getElementById('certModal'));

        function getThaiDate(d = new Date()) {
            const thaiMonths = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
            const day = d.getDate();
            const month = thaiMonths[d.getMonth()];
            const year = d.getFullYear() + 543;
            return `${day} ${month} ${year}`;
        }

        async function generateCert(school, timestamp = null) {
            currentSchool = school;
            const dateStr = timestamp ? getThaiDate(new Date(timestamp)) : getThaiDate();
            const canvas = document.getElementById('certCanvas');
            const ctx = canvas.getContext('2d');
            const dpi = 300;
            const widthMm = 297;
            const heightMm = 210;
            const widthPx = Math.round(widthMm * dpi / 25.4);
            const heightPx = Math.round(heightMm * dpi / 25.4);
            canvas.width = widthPx;
            canvas.height = heightPx;
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, widthPx, heightPx);

            try {
                const flag = new Image();
                flag.crossOrigin = 'anonymous';
                await new Promise((resolve, reject) => { 
                    flag.onload = resolve; 
                    flag.onerror = () => reject(new Error('Failed to load flag image')); 
                    flag.src = flagUrl; 
                });
                const flagSize = Math.min(widthPx * 0.5, heightPx * 0.5);
                const flagX = (widthPx - flagSize) / 2;
                const flagY = (heightPx - flagSize) / 2;
                ctx.globalAlpha = 0.1;
                ctx.drawImage(flag, flagX, flagY, flagSize, flagSize * (flag.height / flag.width));
                ctx.globalAlpha = 1;

                ctx.strokeStyle = '#C8102E';
                ctx.lineWidth = 20;
                ctx.strokeRect(20, 20, widthPx - 40, heightPx - 40);
                ctx.strokeStyle = '#002654';
                ctx.lineWidth = 10;
                ctx.strokeRect(40, 40, widthPx - 80, heightPx - 80);

                const logoSize = 400;
                const logoImg1 = new Image();
                logoImg1.crossOrigin = 'anonymous';
                await new Promise((resolve, reject) => { 
                    logoImg1.onload = resolve; 
                    logoImg1.onerror = () => reject(new Error('Failed to load logo1')); 
                    logoImg1.src = logo1; 
                });
                ctx.drawImage(logoImg1, (widthPx - logoSize) / 2, 100, logoSize, logoSize * (logoImg1.height / logoImg1.width));
                const logoImg2 = new Image();
                logoImg2.crossOrigin = 'anonymous';
                await new Promise((resolve, reject) => { 
                    logoImg2.onload = resolve; 
                    logoImg2.onerror = () => reject(new Error('Failed to load logo2')); 
                    logoImg2.src = logo2; 
                });
                ctx.drawImage(logoImg2, (widthPx - logoSize) / 2, heightPx - 600, logoSize, logoSize * (logoImg2.height / logoImg2.width));

                ctx.fillStyle = '#000000';
                ctx.textAlign = 'center';
                let y = 100 + logoSize + 100;
                ctx.font = 'bold 60px Noto Sans Thai';
                ctx.fillText('สำนักงานเขตพื้นที่การศึกษาประถมศึกษาชลบุรี เขต 2', widthPx / 2, y);
                y += 80;
                ctx.fillText('ขอมอบเกียรติบัตรฉบับนี้ให้ไว้เพื่อแสดงว่า', widthPx / 2, y);
                y += 80;
                ctx.font = 'bold 70px Noto Sans Thai';
                ctx.fillText(school, widthPx / 2, y);
                y += 80;
                ctx.font = '50px Noto Sans Thai';
                ctx.fillText('ได้แสดงความจงรักภักดีต่อสถาบันหลักของชาติ ความสามัคคีเป็นหนึ่งเดียวของคนไทย', widthPx / 2, y);
                y += 60;
                ctx.fillText('และเป็นกำลังใจสำคัญแก่เหล่าทหารกล้า', widthPx / 2, y);
                y += 60;
                ctx.fillText('ขออำนวยพรให้ประสบความสุข ความเจริญก้าวหน้าตลอดไป', widthPx / 2, y);
                y += 80;
                ctx.font = '40px Noto Sans Thai';
                ctx.fillText(`ให้ไว้ ณ วันที่ ${dateStr}`, widthPx / 2, y);
                y = heightPx - 600 + logoSize + 50;
                ctx.font = '50px Noto Sans Thai';
                ctx.fillText('(นายวันชัย หวังสวาสดิ์)', widthPx / 2, y);
                y += 60;
                ctx.fillText('ผู้อำนวยการสำนักงานเขตพื้นที่การศึกษาประถมศึกษาชลบุรี เขต 2', widthPx / 2, y);

                document.getElementById('downloadPng').disabled = false;
                document.getElementById('downloadJpg').disabled = false;
                document.getElementById('downloadPdf').disabled = false;
            } catch (e) {
                console.error('Error generating certificate:', e.message, e.stack);
                throw e;
            }
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        document.getElementById('downloadPng').addEventListener('click', () => {
            document.getElementById('certCanvas').toBlob((blob) => {
                downloadBlob(blob, `${currentSchool}_certificate.png`);
            }, 'image/png');
        });

        document.getElementById('downloadJpg').addEventListener('click', () => {
            document.getElementById('certCanvas').toBlob((blob) => {
                downloadBlob(blob, `${currentSchool}_certificate.jpg`);
            }, 'image/jpeg', 0.95);
        });

        document.getElementById('downloadPdf').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const imgData = document.getElementById('certCanvas').toDataURL('image/png');
            pdf.addImage(imgData, 'PNG', 0, 0, 297, 210);
            pdf.save(`${currentSchool}_certificate.pdf`);
        });

        async function loadTable() {
            try {
                console.log('Attempting to load table from:', scriptUrl); // Debug
                const response = await fetch(scriptUrl, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit'
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status} ${response.statusText}`);
                const data = await response.json();
                console.log('Table data received:', data); // Debug
                if (data.status === 'error') throw new Error(data.message);
                $('#schoolTable').DataTable({
                    data: data,
                    columns: [
                        { data: null, render: (data, type, row, meta) => meta.row + 1 },
                        { data: 1 },
                        { data: 5, render: (d) => `<a href="${d}" target="_blank">ดูคลิป</a>` },
                        { data: null, render: (d, t, row) => `<button class="btn btn-sm btn-info" onclick="showPastCert('${row[1]}', '${row[0]}')">ดู</button>` }
                    ],
                    language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/th.json' },
                    pageLength: 10,
                    order: [],
                    destroy: true
                });
            } catch (err) {
                console.error('Error loading table:', err.message, err.stack); // Debug
                Swal.fire('ข้อผิดพลาด', `ไม่สามารถโหลดข้อมูลตารางได้: ${err.message}`, 'error');
            }
        }
        loadTable();

        window.showPastCert = async (school, timestamp) => {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('downloadPng').disabled = true;
            document.getElementById('downloadJpg').disabled = true;
            document.getElementById('downloadPdf').disabled = true;
            certModal.show();
            try {
                await generateCert(school, timestamp);
                document.getElementById('loading').style.display = 'none';
            } catch (e) {
                Swal.fire('ข้อผิดพลาด', `ไม่สามารถสร้างเกียรติบัตรได้: ${e.message}`, 'error');
                document.getElementById('loading').style.display = 'none';
            }
        };

        document.getElementById('submitForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const school = document.getElementById('school').value;
            const name = document.getElementById('name').value;
            const position = document.getElementById('position').value;
            const phone = document.getElementById('phone').value;
            const url = document.getElementById('url').value;
            const data = { school, name, position, phone, url };
            try {
                console.log('Attempting to submit data to:', scriptUrl, data); // Debug
                const res = await fetch(scriptUrl, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors',
                    credentials: 'omit'
                });
                if (!res.ok) throw new Error(`HTTP error! Status: ${res.status} ${res.statusText}`);
                const result = await res.json();
                console.log('Submit response:', result); // Debug
                if (result.status === 'success') {
                    Swal.fire('สำเร็จ', 'บันทึกข้อมูลเรียบร้อย', 'success');
                    loadTable();
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('downloadPng').disabled = true;
                    document.getElementById('downloadJpg').disabled = true;
                    document.getElementById('downloadPdf').disabled = true;
                    certModal.show();
                    await generateCert(school);
                    document.getElementById('loading').style.display = 'none';
                } else {
                    throw new Error(result.message || 'Unknown error');
                }
            } catch (err) {
                console.error('Error submitting form:', err.message, err.stack); // Debug
                Swal.fire('ข้อผิดพลาด', `เกิดข้อผิดพลาดในการเชื่อมต่อ: ${err.message}`, 'error');
            }
        });
    </script>
</body>
</html>